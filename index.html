<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title></title>
        <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
        <!-- Font Awesome icons (free version)-->
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <!-- Google fonts-->
        <link rel="preconnect" href="https://fonts.gstatic.com" />
        <link href="https://fonts.googleapis.com/css2?family=Tinos:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" rel="stylesheet" />
        <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400;1,500;1,700&amp;display=swap" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="css/styles.css" rel="stylesheet" />
    </head>
    <body>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            var interval; // interval 변수 선언
            $('#progress').text('Progress: 0%');
            
            $(document).ready(function() {
                $('#convert-form').submit(function(event) {
                    event.preventDefault();  // 폼 기본 동작 방지
        
                    var formData = new FormData(this);
        
                    $.ajax({
                        // url: 'http://127.0.0.1:5000/convert',
                        url: 'https://8j5ngxuajc.execute-api.ap-northeast-2.amazonaws.com/production/convert',
                        type: 'POST',
                        data: formData,
                        dataType: 'json',
                        contentType: false,
                        processData: false,
                        xhr: function() {
                            var xhr = new window.XMLHttpRequest();
                            xhr.upload.addEventListener('progress', function(event) {
                                if (event.lengthComputable) {
                                    var percent = (event.loaded / event.total) * 100;
                                    var currentProgress = 0;
                                    var increment = 1;  // 2초에 1%씩 증가
                                     interval = setInterval(function() {
                                        if (currentProgress >= 99) {
                                            clearInterval(interval);
                                        } else {
                                            currentProgress += increment;
                                            $('#progress').text('Progress: ' + currentProgress.toFixed(1) + '%');
                                        }
                                    }, 250);  // 2초 간격으로 업데이트
                                }
                            }, false);
                            return xhr;
                        },
                        success: function(response) {
                            if (response.download_link) {
                                clearInterval(interval);
                                $('#download-link').html('<a href="' + response.download_link + '">Download</a>');
                                $('#download-link').show();
                                $('#progress').text('Progress: 100%');
                                alert('Convert Success')
                            }
                        },
                        error: function(xhr, status, error) {
                            console.log(error);
                        }
                    });
                });
            });
        </script>
        <!-- Background Video-->
        <video class="bg-video" playsinline="playsinline" autoplay="autoplay" muted="muted"><source src="assets/mp4/bg2.mp4" type="video/mp4" /></video>
        <!-- Masthead-->
        <div class="masthead">
            <div class="masthead-content text-white">
                <div class="container-fluid px-4 px-lg-0">
                    <h1 class="fst-italic lh-1 mb-4">Youtube to mp3!<br>let's start convert & download</h1>
                    <p class="mb-5">If you enter the YouTube link and press the button, only the sound of the YouTube video will be downloaded as an mp3 file.</p>
                    <!-- * * * * * * * * * * * * * * *-->
                    <!-- * * SB Forms Contact Form * *-->
                    <!-- * * * * * * * * * * * * * * *-->
                    <!-- This form is pre-integrated with SB Forms.-->
                    <!-- To make this form functional, sign up at-->
                    <!-- https://startbootstrap.com/solution/contact-forms-->
                    <!-- to get an API token!-->
                    <form id="convert-form">
                        <!-- Email address input-->
                        <div class="row input-group-newsletter">
                            <div class="col"><input class="form-control" id="link" type="text" name="youtube_link" placeholder="Enter youtube link..." aria-label="Enter youtube link..." data-sb-validations="required" /></div>
                        </div>
                        <p class="mb-5"> </p>
                        <div class="row input-group-newsletter">
                            <div class="col-auto"><button class="btn btn-primary" id="submitButton" type="submit">Transfer & Download!</button></div>
                        </div>
                        <!-- Submit success message-->
                        <!---->
                        <!-- This is what your users will see when the form-->
                        <!-- has successfully submitted-->
                        <div id="progress" class="mb-5"></div>
                        <div id="download-link" class="mb-5" style="display: none;">
                            <a id="download-btn" href="#" download>Download</a>
                        </div>
                        <!-- Submit error message-->
                        <!---->
                        <!-- This is what your users will see when there is-->
                        <!-- an error submitting the form-->
                        <div class="d-none" id="submitErrorMessage"><div class="text-center text-danger mb-3 mt-2">Error sending message!</div></div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <!-- * *                               SB Forms JS                               * *-->
        <!-- * * Activate your form at https://startbootstrap.com/solution/contact-forms * *-->
        <!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
        <script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
    </body>
</html>
